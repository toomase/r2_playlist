{
    "collab_server" : "",
    "contents" : "---\ntitle: \"R2 õhtuse vööndi playlistis\"\noutput: html_notebook\n---\n\nEesmärk on automaatselt kraapida R2 veebilehelt õhtuse vööndi playlistid, et need seejärel Spotify playlistideks teha.\n\n```{r setup}\nlibrary(RSelenium)\nlibrary(tidyverse)\nlibrary(rvest)\nlibrary(rdom)\nlibrary(stringr)\nlibrary(lubridate)\n```\n\nKoosta loetelu kõigist R2 õhtuse vööndi saadetest koos iga saate url-ga. URL on vajalik, et saate kodulehet playlistid kraapida.\n```{r}\n# Loetelu R2 õhtuse vööndi saadetest\nr2_saate_nimed <- read_html(\"http://r2.err.ee/l/saatesarjad\", encoding = \"utf-8\")\n\n# R2 Õhtuse vööndi saadete nimed ja url-id\nr2_saated <- r2_saate_nimed %>%\n    html_nodes(\"section+ section h6\") %>%\n    html_text() %>%\n    data.frame() %>%\n    select(saade = 1) %>%\n    # Saate nimest on tuletatud url. Kuna osade saadete url on erinev,\n    # siis nende url on käsitsi muudetud\n    mutate(url = str_to_lower(str_c(\"http://r2.err.ee/l/\", \n                                    str_replace_all(saade, \" \", \"\"), sep = \"\"))) %>%\n    mutate(url = str_replace_all(url, \"ö\", \"o\")) %>%\n    mutate(url = str_replace_all(url, \"ž\", \"z\")) %>%\n    mutate(url = str_replace_all(url, \"ä\", \"a\")) %>%\n    mutate(url = ifelse(saade == \"Deeper Shades Of House\",\n                        \"http://r2.err.ee/l/deeper_shades_of_house\", url)) %>%\n    mutate(url = ifelse(saade == \"Haigla saade\",\n                        \"http://r2.err.ee/l/haigla\", url)) %>%\n    arrange(saade)\n\n# Saadete url vektoriks, et neid edaspidi kasutada\nsaate_url <- r2_saated$url\n\nsaate_url\n```\n\nRSeleniumi käivitamine playlistide kraapimiseks. Kuna R2 leht on javascriptis, siis ei saa seda tavapäraselt kraapida ja vaja on Seleniumit, et kunstlikult linke klikkida.\nEsmalt tuleb Ubuntu puhul käivitada Seleniumi server läbi shelli kahe käsurea:\n\n$ sudo docker run -d -p 4445:4444 selenium/standalone-firefox\n$ sudo docker ps\n\nSeleniumi serveri sulgemiseks (käsurea lõpus olev nr on Container ID, mille saab käivituse käsust $ sudo docker ps):\n$ sudo docker stop 7e8466a91673\n\nSeejärel saab ühenduse üles ning alustada veebilehe kraapimist.\n```{r}\nremDr <- remoteDriver(port = 4445L)\nremDr$open()\n```\n\nKraabi kõigi saadete playlistide arv ja kuupäevad. See on vajalik, et hiljem ka playlistid ise kraapida. Kõigepealt koosta funktsioon ühe saate playlistide arvu kraapimiseks ning seejärel eraldi käivita see funktsioon kõigi saadete peale.\n\n```{r}\nplaylist_arv <- function(saade, aasta = 2017){\n  # aasta indeks 2014-st aastast\n  aasta_2 <- aasta - 2014 + 1\n  \n    tryCatch(\n        {\n            remDr$navigate(saade)  # lehele navigeerimine\n            Sys.sleep(2)\n            # vali soovitud aasta\n            aasta <- remDr$findElement(using = 'css', \n                                       paste(\".ng-scope.ng-binding:nth-child(\", aasta_2, \")\", \n                                             sep = \"\"))\n            aasta$clickElement()\n            Sys.sleep(2)\n            doc <- read_html(remDr$getPageSource()[[1]])\n            \n            saadete_arv <- doc %>%\n              html_nodes(\"option\") %>% \n              html_text() %>% \n              data_frame() %>% \n              select(kp = 1) %>% \n              mutate(saade = saade)\n            \n            return(saadete_arv)\n        }, error = function(e) NULL\n    )\n}\n```\n\nKraabi iga õhtuse vööndi saate kohta olemasolevate playlistide kuupäevad, et sellest omakorda tuletada indeksid playlistide enda kraapimiseks.\n```{r}\nr2_saated_playlistide_kp_raw <- map_df(saate_url, playlist_arv, 2016)\n\nr2_saated_playlistide_kp <- r2_saated_playlistide_kp_raw %>% \n  mutate(kp = dmy(kp)) %>% \n  arrange(saade, desc(kp)) %>% \n  group_by(saade) %>% \n  mutate(indeks = row_number() - 1)\n\nr2_saated_playlistide_kp\n```\n\nKirjuta funkstioon, mis kraabib kõik olemasolevad playlistid valitud aasta kohta.\n```{r}\n# alamfunktsioon, mis klikib valitud saate kõik playlistid läbi ja kraabib lugude info. See on tehtud eraldi, et ei peaks iga playlisti jaoks uuesti veebilehte nullist avama.\nkraabi_playlist <- function(y, x){\n  tryCatch(\n    {\n      Sys.sleep(1)\n      # Kuupäevade valimine playlistide kuvamiseks\n      option <- remDr$findElement(using = 'xpath', \n                                        paste(\"//*/option[@value = '\", y, \"']\", sep = \"\"))\n      # Topelt klikk, et oleks valitud\n      option$clickElement()\n      Sys.sleep(1)\n      doc <- read_html(remDr$getPageSource()[[1]])\n\n      playlist_raw <- doc %>%\n        html_nodes(\".playlistitem .ng-scope .ng-binding\") %>%\n        html_text() %>%\n        str_trim() %>%\n        data.frame() %>%\n        filter(. != \"\") %>%\n        mutate(indeks = y, url = x) %>%\n        select(lugu = 1, indeks, url)\n            \n        return(playlist_raw)\n    }, error = function(e) NULL\n  )\n}\n  \n\n# Funktsioon playlisti lugude nimekirja kraapimiseks (url = saate url, indeks = saatega seotud playlistide arv kokku)\nr2_playlist <- function(url, indeks, aasta = 2017){\n  # aasta indeks 2014-st aastast\n  tryCatch(\n    {\n      aasta_2 <- aasta - 2014 + 1\n      remDr$navigate(url)  # lehele navigeerimine\n      Sys.sleep(2)\n      # vali soovitud aasta\n      aasta <- remDr$findElement(using = 'css',\n                                 paste(\".ng-scope.ng-binding:nth-child(\", aasta_2, \")\",\n                                       sep = \"\"))\n      aasta$clickElement()\n      \n      # kliki iga saate kohta kõik valitud aasta playlistid läbi ja salvesta need maha\n      kokku <- map2_df(seq(0, indeks), url, kraabi_playlist)\n      \n      return(kokku)\n    }, error = function(e) NULL\n  )\n}\n```\n\nKoosta eraldi vektorid saate url-ga ning saatega seotud playlistide arvuga.\n```{r}\nurl <- r2_saated_playlistide_kp %>% \n  count(saade) %>% \n  .$saade\n  \nindeks <- r2_saated_playlistide_kp %>% \n  count(saade) %>% \n  .$n - 1\n```\n\nKraabi kõik valitud aasta playlistid ühe korraga ja salvest RData fail.\n```{r}\nsystem.time({\nr2_ohtune_voond_raw <- map2_df(url, indeks, .f = r2_playlist, 2016)\n\nsave(r2_ohtune_voond_raw, file = \"output/r2_ohtune_voond_2016.RData\")\n})\n```\n\n```{r}\nglimpse(r2_ohtune_voond_raw)\nglimpse(r2_saated_playlistide_kp)\n```\n\nLisa saadetele kuupäevad.\n```{r}\nr2_ohtune_voond <- r2_ohtune_voond_raw %>% \n  left_join(r2_saated_playlistide_kp, by = c(\"url\" = \"saade\", \"indeks\" = \"indeks\"))\n```\n\nSalvesta R2 õhtuse vööndi saated 2016. aasta kohta\n```{r}\nsave(r2_ohtune_voond, file = \"output/r2_ohtune_voond_2016.RData\")\n```",
    "created" : 1488138918335.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3636807496",
    "id" : "46F7E87F",
    "lastKnownWriteTime" : 1488055032,
    "last_content_update" : 1488055032,
    "path" : "~/Dropbox/DataScience/R/r2_playlist/01_r2_playlist_2016.Rmd",
    "project_path" : "01_r2_playlist_2016.Rmd",
    "properties" : {
        "chunk_output_type" : "inline"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}